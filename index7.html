<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>恐龙大作战 - 环绕子弹 + 皮肤商店（重写版）</title>
  <style>
    html,body{margin:0;padding:0;background:#0b1020;color:#e8ecff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{display:grid;place-items:center;min-height:100vh}
    canvas{
      background:radial-gradient(1200px 800px at 60% 40%,#18234a 0%,#0b1020 55%,#070a14 100%);
      border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.45)
    }
    .hud{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:10px;flex-wrap:wrap;pointer-events:none}
    .pill{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 12px;font-size:14px;backdrop-filter:blur(6px);user-select:none}
    .hint{position:fixed;bottom:10px;left:10px;right:10px;opacity:.9;font-size:13px}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:50}
    .panel{width:min(900px,calc(100vw - 28px));background:rgba(12,16,36,.96);border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);overflow:hidden}
    .panel header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.10)}
    .panel header h2{margin:0;font-size:16px}
    .panel header .sub{opacity:.8;font-size:13px;margin-top:2px}
    .panel main{padding:14px 16px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    .card{border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:12px;display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{pointer-events:auto;cursor:pointer;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);color:#e8ecff;padding:9px 11px;font-size:13px;user-select:none}
    .btn:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.26)}
    .btn.primary{background:rgba(99,143,255,.22);border-color:rgba(99,143,255,.40)}
    .btn.danger{background:rgba(255,99,132,.18);border-color:rgba(255,99,132,.35)}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08)}
    .muted{opacity:.85;font-size:13px}
    .k{opacity:.8;font-size:12px}
    .skinPreview{display:flex;gap:10px;align-items:center}
    .skinPreview img{width:72px;height:72px;object-fit:contain;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left}
    th{opacity:.85;font-weight:600}
    .ok{color:#93ffb9}.warn{color:#ffd28a}
  </style>
</head>
<body>
  <div class="hud">
    <div class="pill" id="hudStage">Stage 1</div>
    <div class="pill" id="hudTime">Time: 60</div>
    <div class="pill" id="hudHP">HP: ❤❤❤</div>
    <div class="pill" id="hudRevive">Revive: 1</div>
    <div class="pill" id="hudGold">Gold: 0</div>
    <div class="pill" id="hudKills">Kills: 0</div>
    <div class="pill" id="hudScore">Score: 0</div>
    <div class="pill" id="hudOrbit">Orbit: bullets=1 size=x1.00</div>
  </div>

  <div class="wrap">
    <canvas id="c" width="960" height="540"></canvas>
  </div>

  <div class="hint">
    <div class="pill">WASD/方向键移动｜B 商店｜Esc 关闭｜R 重开｜子弹环绕不追踪（碰到怪就打）｜每关1分钟，怪一次性15+刷</div>
  </div>

  <!-- Shop overlay -->
  <div class="overlay" id="shopOverlay">
    <div class="panel">
      <header>
        <div>
          <h2>商店 / 排行榜（B 打开 / Esc 关闭）</h2>
          <div class="sub">金币：击杀 +1｜掉落：子弹变大 / 血量+1 / 子弹数量+1（永久）｜皮肤只改外观</div>
        </div>
        <button class="btn danger" id="btnCloseShop">关闭</button>
      </header>
      <main>
        <div class="row">
          <div class="tag">当前金币：<span id="shopGold">0</span></div>
          <div class="muted" id="shopStatus">—</div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="row"><div><b>升级：环绕子弹数量 +1</b></div><span class="tag">250 金币</span></div>
            <div class="muted">永久增加环绕子弹数量</div>
            <button class="btn primary" id="buyMoreBullets">购买</button>
            <div class="k" id="buyMoreBulletsState"></div>
          </div>

          <div class="card">
            <div class="row"><div><b>升级：子弹大小 +1级</b></div><span class="tag">250 金币</span></div>
            <div class="muted">永久变大，命中更容易</div>
            <button class="btn primary" id="buyBigger">购买</button>
            <div class="k" id="buyBiggerState"></div>
          </div>
        </div>

        <div class="card">
          <div class="row"><div><b>皮肤商店</b></div><span class="tag">购买后可装备</span></div>
          <div class="grid" id="skinGrid"></div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="row"><div><b>已获得技能（掉落）</b></div><span class="tag">永久</span></div>
            <div class="muted" id="skillList">暂无</div>
          </div>

          <div class="card">
            <div class="row"><div><b>排行榜（本机）</b></div><span class="tag">Top 10</span></div>
            <div class="muted">游戏结束会自动写入（同一台电脑保存）</div>
            <table>
              <thead><tr><th>#</th><th>Score</th><th>Kills</th><th>Stage</th></tr></thead>
              <tbody id="lbBody"></tbody>
            </table>
            <button class="btn" id="btnClearLB">清空排行榜</button>
          </div>
        </div>
      </main>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  // ===== 强制焦点：彻底解决“动不了” =====
  canvas.tabIndex = 0;
  canvas.style.outline = "none";
  const focusCanvas = () => { try { canvas.focus(); } catch {} };
  setTimeout(focusCanvas, 0);
  canvas.addEventListener("click", focusCanvas);

  // ===== HUD =====
  const hudStage  = document.getElementById("hudStage");
  const hudTime   = document.getElementById("hudTime");
  const hudHP     = document.getElementById("hudHP");
  const hudRevive = document.getElementById("hudRevive");
  const hudGold   = document.getElementById("hudGold");
  const hudKills  = document.getElementById("hudKills");
  const hudScore  = document.getElementById("hudScore");
  const hudOrbit  = document.getElementById("hudOrbit");

  // ===== Shop =====
  const shopOverlay = document.getElementById("shopOverlay");
  const btnCloseShop = document.getElementById("btnCloseShop");
  const shopGold = document.getElementById("shopGold");
  const shopStatus = document.getElementById("shopStatus");
  const buyMoreBullets = document.getElementById("buyMoreBullets");
  const buyBigger = document.getElementById("buyBigger");
  const buyMoreBulletsState = document.getElementById("buyMoreBulletsState");
  const buyBiggerState = document.getElementById("buyBiggerState");
  const skinGrid = document.getElementById("skinGrid");
  const skillList = document.getElementById("skillList");

  // leaderboard ui
  const lbBody = document.getElementById("lbBody");
  const btnClearLB = document.getElementById("btnClearLB");

  // ===== 音效 =====
  const AudioFx = (() => {
    let ac = null;
    const ensure = () => (ac ||= new (window.AudioContext || window.webkitAudioContext)());
    const beep = (f=440, d=0.07, type="sine", v=0.08) => {
      const c = ensure();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = f;
      g.gain.value = v;
      o.connect(g); g.connect(c.destination);
      o.start();
      o.stop(c.currentTime + d);
    };
    return {
      open:   () => beep(320, 0.06, "sine", 0.07),
      hit:    () => beep(180, 0.06, "square", 0.06),
      kill:   () => beep(520, 0.07, "triangle", 0.08),
      pickup: () => beep(740, 0.08, "sine", 0.07),
    };
  })();

  // ===== 工具函数 =====
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const dist2 = (ax,ay,bx,by)=>{ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; };

  // ===== 资源：皮肤（用文件路径，不用 base64）=====
  const SKIN_PATH = "./assets/skins/";
  const IMG_DEFAULT = new Image();
  IMG_DEFAULT.src = SKIN_PATH + "default.png";

  const SKINS = [
    { id:"default",   name:"默认(炮)", price:0,   src:SKIN_PATH + "default.png" },
    { id:"beam_hat",  name:"激光帽",   price:600, src:SKIN_PATH + "beam_hat.png" },
    { id:"missile",   name:"火箭筒",   price:800, src:SKIN_PATH + "missile.png" },
    { id:"king",      name:"国王披风", price:900, src:SKIN_PATH + "king.png" },
    { id:"beam_glow", name:"激光眼",   price:700, src:SKIN_PATH + "beam_glow.png" },
    { id:"fire",      name:"喷火龙",   price:650, src:SKIN_PATH + "fire.png" },
  ];

  const skinImages = new Map();
  for (const s of SKINS) {
    const im = new Image();
    im.src = s.src;
    skinImages.set(s.id, im);
  }

  // ===== 输入 =====
  const keys = new Set();
  const onKeyDown = (e) => {
    const k = e.key.toLowerCase();
    if (["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
    keys.add(k);

    if (k === "b" && !state.ended) toggleShop();
    if (k === "escape" && state.shopOpen) closeShop();
    if (k === "r") restart();
  };
  const onKeyUp = (e) => keys.delete(e.key.toLowerCase());

  document.addEventListener("keydown", onKeyDown, {passive:false});
  document.addEventListener("keyup", onKeyUp);

  window.addEventListener("blur", ()=> keys.clear());

  // ===== 排行榜 =====
  const LB_KEY = "dino_leaderboard_v1";
  const loadLB = () => {
    try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); } catch { return []; }
  };
  const saveLB = (rows) => {
    try { localStorage.setItem(LB_KEY, JSON.stringify(rows)); } catch {}
  };
  const renderLB = () => {
    const rows = loadLB();
    lbBody.innerHTML = "";
    rows.slice(0,10).forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${r.score}</td><td>${r.kills}</td><td>${r.stage}</td>`;
      lbBody.appendChild(tr);
    });
    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">暂无记录</td>`;
      lbBody.appendChild(tr);
    }
  };
  btnClearLB.onclick = () => { saveLB([]); renderLB(); setShopStatus("已清空排行榜", false); };

  // ===== 游戏状态 =====
  let state;
  const ownedKey = "dino_owned_skins_v1";

  function resetGame() {
    state = {
      player: {
        x: W/2, y: H/2,
        r: 18,
        speed: 260,
        hpMax: 3,
        hp: 3,
        spriteId: "default",
      },
      revive: 1,
      invuln: 0,

      gold: 0,
      kills: 0,
      score: 0,

      // orbit
      orbitCount: 1,
      orbitSizeLv: 0,
      orbitBaseR: 8,
      orbitGap: 44,
      orbitSpeed: 2.05,
      orbitAngle: 0,

      // buffs from drops
      buffs: { bigger: 0, hp: 0, more: 0 },

      // stage
      stage: 1,
      stageTime: 60,
      stageLeft: 60,

      enemies: [],
      enemyBullets: [],
      drops: [],

      shopOpen: false,
      ended: false,

      ownedSkins: { default: true },
    };

    // load owned skins
    try {
      const saved = JSON.parse(localStorage.getItem(ownedKey) || "{}");
      state.ownedSkins = { ...state.ownedSkins, ...saved };
    } catch {}

    buildSkinShop();
    spawnWave(true);
    updateHUD();
    renderLB();
  }

  function persistOwned() {
    try { localStorage.setItem(ownedKey, JSON.stringify(state.ownedSkins)); } catch {}
  }

  // ===== 敌人强度随关卡 =====
  function enemyStats(stage) {
    const hp = 1 + Math.floor(stage/4);
    const speed = 92 + stage*8;
    const rangedChance = clamp((stage - 4)*0.09, 0, 0.70);
    const bulletSpeed = 240 + stage*12;
    const fireRate = clamp(1.10 - stage*0.03, 0.40, 1.10);
    return { hp, speed, rangedChance, bulletSpeed, fireRate };
  }

  // 一次性刷 15+
  function spawnWave(clearOld=false) {
    if (clearOld) state.enemies.length = 0;

    const base = 15;
    const extra = Math.floor(state.stage * 2.0);
    const n = base + extra;

    const s = enemyStats(state.stage);

    for (let i=0;i<n;i++){
      const side = Math.floor(rand(0,4));
      let x,y;
      if (side===0){ x = rand(-180,-60); y = rand(-120, H+120); }
      if (side===1){ x = rand(W+60, W+180); y = rand(-120, H+120); }
      if (side===2){ x = rand(-120, W+120); y = rand(-180,-60); }
      if (side===3){ x = rand(-120, W+120); y = rand(H+60, H+180); }

      const ranged = Math.random() < s.rangedChance;
      state.enemies.push({
        x,y,
        r: ranged ? 14 : 12,
        hp: s.hp + (ranged ? 1 : 0),
        speed: s.speed * (ranged ? 0.96 : 1.06),
        ranged,
        cd: rand(0.2, 1.2),
        fireRate: s.fireRate,
        bulletSpeed: s.bulletSpeed,
        alive: true,
      });
    }
  }

  // 掉落 3 种技能
  function maybeDrop(x,y){
    if (Math.random() > 0.22) return;
    const pool = ["bigger","hp","more"];
    const type = pool[Math.floor(Math.random()*pool.length)];
    state.drops.push({ x,y, r:10, type, t:0, alive:true });
  }

  function applyDrop(type){
    if (type==="bigger") state.buffs.bigger++;
    if (type==="hp"){
      state.buffs.hp++;
      state.player.hpMax++;
      state.player.hp = Math.min(state.player.hp+1, state.player.hpMax);
    }
    if (type==="more") state.buffs.more++;

    state.orbitCount = 1 + state.buffs.more;
    AudioFx.pickup();
    updateShopUI();
  }

  // ===== 环绕子弹 =====
  function orbitBullets(){
    const p = state.player;
    const count = state.orbitCount;
    const gap = state.orbitGap + state.orbitSizeLv*6;
    const sizeMult = (1 + state.orbitSizeLv*0.25 + state.buffs.bigger*0.25);
    const br = state.orbitBaseR * sizeMult;

    const arr = [];
    const a0 = state.orbitAngle;
    for (let i=0;i<count;i++){
      const a = a0 + (Math.PI*2)*(i/count);
      arr.push({
        x: p.x + Math.cos(a)*gap,
        y: p.y + Math.sin(a)*gap,
        r: br
      });
    }
    return arr;
  }

  // ===== 敌人射击 =====
  function enemyShoot(e){
    const p = state.player;
    const dx = p.x - e.x, dy = p.y - e.y;
    const d = Math.hypot(dx,dy) || 1;
    const ux = dx/d, uy = dy/d;
    state.enemyBullets.push({ x:e.x, y:e.y, vx:ux*e.bulletSpeed, vy:uy*e.bulletSpeed, r:6, alive:true });
  }

  // ===== 商店 =====
  btnCloseShop.onclick = ()=> closeShop();

  buyMoreBullets.onclick = ()=>{
    if (state.gold < 250) return setShopStatus("金币不够", true);
    state.gold -= 250;
    state.buffs.more++;
    state.orbitCount = 1 + state.buffs.more;
    AudioFx.open();
    setShopStatus("购买成功：子弹数量+1", false);
    updateShopUI();
  };

  buyBigger.onclick = ()=>{
    if (state.gold < 250) return setShopStatus("金币不够", true);
    state.gold -= 250;
    state.orbitSizeLv++;
    AudioFx.open();
    setShopStatus("购买成功：子弹更大", false);
    updateShopUI();
  };

  function setShopStatus(msg, warn=false){
    shopStatus.textContent = msg;
    shopStatus.className = warn ? "muted warn" : "muted ok";
    setTimeout(()=>{ shopStatus.textContent="—"; shopStatus.className="muted"; }, 1200);
  }

  function openShop(){
    state.shopOpen = true;
    shopOverlay.style.display = "flex";
    AudioFx.open();
    updateShopUI();
    renderLB();
  }
  function closeShop(){
    state.shopOpen = false;
    shopOverlay.style.display = "none";
    focusCanvas();
  }
  function toggleShop(){
    state.shopOpen ? closeShop() : openShop();
  }

  function equipSkin(id){
    if (!state.ownedSkins[id]) return setShopStatus("先购买再装备", true);
    state.player.spriteId = id;
    AudioFx.open();
    setShopStatus("已装备：" + SKINS.find(s=>s.id===id).name, false);
    buildSkinShop();
  }

  function buySkin(id){
    const s = SKINS.find(x=>x.id===id);
    if (!s) return;
    if (state.ownedSkins[id]) return;
    if (state.gold < s.price) return setShopStatus("金币不够", true);
    state.gold -= s.price;
    state.ownedSkins[id] = true;
    persistOwned();
    AudioFx.open();
    setShopStatus("购买成功：" + s.name, false);
    buildSkinShop();
    updateShopUI();
  }

  function buildSkinShop(){
    skinGrid.innerHTML = "";
    for (const s of SKINS){
      const owned = !!state.ownedSkins[s.id];
      const equipped = state.player.spriteId === s.id;

      const card = document.createElement("div");
      card.className = "card";

      const row = document.createElement("div");
      row.className = "row";

      const left = document.createElement("div");
      left.className = "skinPreview";

      const img = document.createElement("img");
      img.src = s.src;
      img.onerror = () => { img.style.opacity = "0.35"; img.title = "图片没加载到：检查 assets/skins 路径与文件名"; };
      left.appendChild(img);

      const info = document.createElement("div");
      info.innerHTML = `<div><b>${s.name}</b></div><div class="muted">${s.price===0?"免费":(s.price+" 金币")}</div>`;
      left.appendChild(info);

      const btnWrap = document.createElement("div");
      btnWrap.style.display="flex";
      btnWrap.style.gap="8px";

      const btnBuy = document.createElement("button");
      btnBuy.className = "btn primary";
      btnBuy.textContent = owned ? "已拥有" : "购买";
      btnBuy.disabled = owned || s.price===0;
      btnBuy.onclick = ()=> buySkin(s.id);

      const btnEquip = document.createElement("button");
      btnEquip.className = "btn";
      btnEquip.textContent = equipped ? "已装备" : "装备";
      btnEquip.disabled = equipped;
      btnEquip.onclick = ()=> equipSkin(s.id);

      btnWrap.appendChild(btnBuy);
      btnWrap.appendChild(btnEquip);

      row.appendChild(left);
      row.appendChild(btnWrap);

      card.appendChild(row);

      const note = document.createElement("div");
      note.className="k";
      note.textContent = s.id==="default" ? "默认皮肤" : "只改变外观（不加属性）";
      card.appendChild(note);

      skinGrid.appendChild(card);
    }
  }

  function updateShopUI(){
    shopGold.textContent = String(state.gold);
    buyMoreBulletsState.textContent = `当前：${state.orbitCount}（包含掉落）`;
    buyBiggerState.textContent = `当前：等级 ${state.orbitSizeLv}（掉落也会放大）`;

    const parts = [];
    if (state.buffs.bigger) parts.push(`子弹变大 +${state.buffs.bigger}`);
    if (state.buffs.hp) parts.push(`血量+${state.buffs.hp}`);
    if (state.buffs.more) parts.push(`子弹数量+${state.buffs.more}`);
    skillList.textContent = parts.length ? parts.join(" ｜ ") : "暂无";
  }

  // ===== HUD =====
  function updateHUD(){
    hudStage.textContent = `Stage ${state.stage}`;
    hudTime.textContent  = `Time: ${Math.max(0, Math.ceil(state.stageLeft))}`;
    hudHP.textContent    = `HP: ${"❤".repeat(state.player.hp)}${"·".repeat(Math.max(0, state.player.hpMax-state.player.hp))}`;
    hudRevive.textContent = `Revive: ${state.revive}`;
    hudGold.textContent  = `Gold: ${state.gold}`;
    hudKills.textContent = `Kills: ${state.kills}`;
    hudScore.textContent = `Score: ${state.score}`;
    const sizeMult = (1 + state.orbitSizeLv*0.25 + state.buffs.bigger*0.25);
    hudOrbit.textContent = `Orbit: bullets=${state.orbitCount} size=x${sizeMult.toFixed(2)}`;
  }

  // ===== 伤害 + 复活 =====
  function damagePlayer(){
    if (state.invuln > 0) return;
    state.player.hp--;
    state.invuln = 0.55;
    AudioFx.hit();

    if (state.player.hp <= 0){
      if (state.revive > 0){
        // revive once
        state.revive--;
        state.player.hp = state.player.hpMax;
        state.invuln = 1.2;
        AudioFx.open();
      } else {
        endGame();
      }
    }
  }

  // ===== 游戏结束：写排行榜 =====
  function endGame(){
    if (state.ended) return;
    state.ended = true;

    // write leaderboard
    const rows = loadLB();
    rows.push({ score: state.score, kills: state.kills, stage: state.stage });
    rows.sort((a,b)=> b.score - a.score);
    saveLB(rows.slice(0,10));
    renderLB();
  }

  // ===== 主更新 =====
  function step(dt){
    if (state.shopOpen || state.ended) return;

    state.invuln = Math.max(0, state.invuln - dt);

    // stage timer
    state.stageLeft -= dt;
    if (state.stageLeft <= 0){
      state.stage++;
      state.stageLeft = state.stageTime;
      spawnWave(false); // 继续叠加更刺激
    }

    // movement
    let mx=0,my=0;
    if (keys.has("w") || keys.has("arrowup")) my -= 1;
    if (keys.has("s") || keys.has("arrowdown")) my += 1;
    if (keys.has("a") || keys.has("arrowleft")) mx -= 1;
    if (keys.has("d") || keys.has("arrowright")) mx += 1;

    const l = Math.hypot(mx,my);
    if (l > 0){ mx/=l; my/=l; }

    const p = state.player;
    p.x = clamp(p.x + mx*p.speed*dt, p.r, W-p.r);
    p.y = clamp(p.y + my*p.speed*dt, p.r, H-p.r);

    // orbit angle
    state.orbitAngle += state.orbitSpeed * dt;
    const orbs = orbitBullets();

    // enemies
    for (const e of state.enemies){
      if (!e.alive) continue;

      const dx = p.x - e.x, dy = p.y - e.y;
      const d = Math.hypot(dx,dy) || 1;
      const ux = dx/d, uy = dy/d;

      e.x += ux * e.speed * dt;
      e.y += uy * e.speed * dt;

      // touch
      if (dist2(e.x,e.y,p.x,p.y) <= (e.r+p.r)**2){
        e.x -= ux*10; e.y -= uy*10;
        damagePlayer();
        if (state.ended) break;
      }

      // ranged shoot
      if (e.ranged){
        e.cd -= dt;
        if (e.cd <= 0){
          enemyShoot(e);
          e.cd = e.fireRate;
        }
      }

      // orbit hits (no tracking)
      for (const b of orbs){
        if (dist2(e.x,e.y,b.x,b.y) <= (e.r+b.r)**2){
          e.hp -= 1;
          if (e.hp <= 0){
            e.alive = false;
            state.kills++;
            state.gold++;
            state.score += 10 + Math.floor(state.stage*2);
            AudioFx.kill();
            maybeDrop(e.x, e.y);
          }
          break;
        }
      }
    }

    // enemy bullets
    for (const bl of state.enemyBullets){
      if (!bl.alive) continue;
      bl.x += bl.vx * dt;
      bl.y += bl.vy * dt;
      if (bl.x < -100 || bl.x > W+100 || bl.y < -100 || bl.y > H+100){ bl.alive=false; continue; }
      if (dist2(bl.x,bl.y,p.x,p.y) <= (bl.r+p.r)**2){
        bl.alive=false;
        damagePlayer();
        if (state.ended) break;
      }
    }

    // drops
    for (const d of state.drops){
      if (!d.alive) continue;
      d.t += dt;
      if (dist2(d.x,d.y,p.x,p.y) <= (d.r+p.r)**2){
        d.alive = false;
        applyDrop(d.type);
      }
    }

    // cleanup
    state.enemies = state.enemies.filter(e=>e.alive);
    state.enemyBullets = state.enemyBullets.filter(b=>b.alive);
    state.drops = state.drops.filter(d=>d.alive);

    updateHUD();
  }

  // ===== 绘制 =====
  function draw(){
    ctx.clearRect(0,0,W,H);

    // star dots
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = "#fff";
    for (let y=18;y<H;y+=36) for (let x=18;x<W;x+=36) ctx.fillRect(x,y,1,1);
    ctx.restore();

    // drops
    for (const d of state.drops){
      ctx.save();
      ctx.translate(d.x, d.y + Math.sin(d.t*6)*2);
      ctx.fillStyle = "rgba(99,143,255,.95)";
      ctx.beginPath(); ctx.arc(0,0,d.r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(0,0,0,.45)";
      ctx.beginPath(); ctx.arc(0,0,d.r*0.55,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // enemy bullets
    for (const b of state.enemyBullets){
      ctx.save();
      ctx.fillStyle = "rgba(140,208,255,.92)";
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // enemies
    for (const e of state.enemies){
      ctx.save();
      ctx.fillStyle = e.ranged ? "rgba(138,208,255,.92)" : "rgba(255,122,168,.92)";
      ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();

      // eyes
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.beginPath();
      ctx.arc(e.x - e.r*0.25, e.y - e.r*0.18, Math.max(2, e.r*0.12), 0, Math.PI*2);
      ctx.arc(e.x + e.r*0.25, e.y - e.r*0.18, Math.max(2, e.r*0.12), 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
    }

    // orbit bullets
    const orbs = orbitBullets();
    for (const b of orbs){
      ctx.save();
      ctx.fillStyle = "rgba(255,190,110,.95)";
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = "rgba(255,255,255,.75)";
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // player sprite
    const p = state.player;
    const size = 86;
    const img = skinImages.get(p.spriteId);

    ctx.save();
    if (state.invuln > 0) ctx.globalAlpha = 0.65;

    // 如果图片没加载到，就画个圆当占位
    if (img && img.complete && img.naturalWidth > 0){
      ctx.drawImage(img, p.x - size/2, p.y - size/2, size, size);
    } else {
      ctx.fillStyle = "rgba(120,255,160,.9)";
      ctx.beginPath(); ctx.arc(p.x,p.y,24,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // Game over overlay
    if (state.ended){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "bold 36px system-ui";
      ctx.fillText("游戏结束", W/2 - 72, H/2 - 16);
      ctx.font = "16px system-ui";
      ctx.fillText(`Kills: ${state.kills}   Score: ${state.score}   Stage: ${state.stage}`, W/2 - 170, H/2 + 18);
      ctx.fillText("按 R 重新开始｜按 B 看商店/排行榜", W/2 - 150, H/2 + 46);
      ctx.restore();
    }
  }

  // ===== 循环 =====
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;
    step(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function restart(){
    closeShop();
    resetGame();
  }

  // init
  resetGame();
  updateHUD();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
