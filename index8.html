<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dino Battle - Orbit Fireballs + Skins Shop</title>
  <style>
    html,body{margin:0;padding:0;background:#0b1020;color:#e8ecff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{display:grid;place-items:center;min-height:100vh}
    canvas{
      background:radial-gradient(1200px 800px at 60% 40%,#18234a 0%,#0b1020 55%,#070a14 100%);
      border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.45)
    }
    .hud{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:10px;flex-wrap:wrap;pointer-events:none}
    .pill{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 12px;font-size:14px;backdrop-filter:blur(6px);user-select:none}
    .hint{position:fixed;bottom:10px;left:10px;right:10px;opacity:.92;font-size:13px}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:50}
    .panel{width:min(940px,calc(100vw - 28px));background:rgba(12,16,36,.96);border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);overflow:hidden}
    .panel header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.10)}
    .panel header h2{margin:0;font-size:16px}
    .panel header .sub{opacity:.8;font-size:13px;margin-top:2px}
    .panel main{
      padding:14px 16px;
      display:grid;
      gap:12px;
      max-height:min(76vh,720px);
      overflow:auto;            /* ✅ scroll with mouse wheel */
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    .card{border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:12px;display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{pointer-events:auto;cursor:pointer;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);color:#e8ecff;padding:9px 11px;font-size:13px;user-select:none}
    .btn:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.26)}
    .btn.primary{background:rgba(99,143,255,.22);border-color:rgba(99,143,255,.40)}
    .btn.danger{background:rgba(255,99,132,.18);border-color:rgba(255,99,132,.35)}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08)}
    .muted{opacity:.85;font-size:13px}
    .k{opacity:.8;font-size:12px}
    .skinPreview{display:flex;gap:10px;align-items:center}
    .skinPreview img{width:72px;height:72px;object-fit:contain;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left}
    th{opacity:.85;font-weight:600}
    .ok{color:#93ffb9}.warn{color:#ffd28a}
  </style>
</head>
<body>
  <div class="hud">
    <div class="pill" id="hudStage">Stage 1</div>
    <div class="pill" id="hudTime">Time: 120</div>
    <div class="pill" id="hudWave">Wave: 1/7</div>
    <div class="pill" id="hudHP">HP: ❤❤❤</div>
    <div class="pill" id="hudRevive">Revive: 1</div>
    <div class="pill" id="hudGold">Gold: 0</div>
    <div class="pill" id="hudKills">Kills: 0</div>
    <div class="pill" id="hudScore">Score: 0</div>
    <div class="pill" id="hudOrbit">Orbit: balls=1 size=x1.00 range=44</div>
  </div>

  <div class="wrap">
    <canvas id="c" width="960" height="540"></canvas>
  </div>

  <div class="hint">
    <div class="pill">
      Move: WASD / Arrow Keys · Shop: B · Close: Esc · Restart: R ·
      Fireballs orbit (no tracking) · Each stage is 2 minutes, at least 7 waves, ~15 enemies per wave
    </div>
  </div>

  <!-- Shop overlay -->
  <div class="overlay" id="shopOverlay">
    <div class="panel">
      <header>
        <div>
          <h2>Shop + Leaderboard</h2>
          <div class="sub">Gold: +1 per kill · No drop system · Skins have small bonuses</div>
        </div>
        <button class="btn danger" id="btnCloseShop">Close</button>
      </header>
      <main>
        <div class="row">
          <div class="tag">Gold: <span id="shopGold">0</span></div>
          <div class="muted" id="shopStatus">—</div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="row"><div><b>Upgrade: +1 Fireball</b></div><span class="tag">30 Gold</span></div>
            <div class="muted">Adds one more orbit fireball (permanent).</div>
            <button class="btn primary" id="buyMoreBalls">Buy</button>
            <div class="k" id="buyMoreBallsState"></div>
          </div>

          <div class="card">
            <div class="row"><div><b>Upgrade: +Orbit Range</b></div><span class="tag">30 Gold</span></div>
            <div class="muted">Fireballs orbit farther (hits more safely).</div>
            <button class="btn primary" id="buyMoreRange">Buy</button>
            <div class="k" id="buyMoreRangeState"></div>
          </div>
        </div>

        <div class="card">
          <div class="row"><div><b>Skins</b></div><span class="tag">Buy & Equip</span></div>
          <div class="grid" id="skinGrid"></div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="row"><div><b>Skin Bonus (current)</b></div><span class="tag">Active</span></div>
            <div class="muted" id="skinBonusText">—</div>
          </div>

          <div class="card">
            <div class="row"><div><b>Leaderboard (local)</b></div><span class="tag">Top 10</span></div>
            <table>
              <thead><tr><th>#</th><th>Score</th><th>Kills</th><th>Stage</th></tr></thead>
              <tbody id="lbBody"></tbody>
            </table>
            <button class="btn" id="btnClearLB">Clear Leaderboard</button>
          </div>
        </div>
      </main>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  // ✅ hard focus to avoid "can't move"
  canvas.tabIndex = 0;
  canvas.style.outline = "none";
  const focusCanvas = () => { try { canvas.focus(); } catch {} };
  setTimeout(focusCanvas, 0);
  canvas.addEventListener("click", focusCanvas);
  window.addEventListener("blur", ()=> keys.clear());

  // HUD
  const hudStage  = document.getElementById("hudStage");
  const hudTime   = document.getElementById("hudTime");
  const hudWave   = document.getElementById("hudWave");
  const hudHP     = document.getElementById("hudHP");
  const hudRevive = document.getElementById("hudRevive");
  const hudGold   = document.getElementById("hudGold");
  const hudKills  = document.getElementById("hudKills");
  const hudScore  = document.getElementById("hudScore");
  const hudOrbit  = document.getElementById("hudOrbit");

  // Shop UI
  const shopOverlay = document.getElementById("shopOverlay");
  const btnCloseShop = document.getElementById("btnCloseShop");
  const shopGold = document.getElementById("shopGold");
  const shopStatus = document.getElementById("shopStatus");
  const buyMoreBalls = document.getElementById("buyMoreBalls");
  const buyMoreRange = document.getElementById("buyMoreRange");
  const buyMoreBallsState = document.getElementById("buyMoreBallsState");
  const buyMoreRangeState = document.getElementById("buyMoreRangeState");
  const skinGrid = document.getElementById("skinGrid");
  const skinBonusText = document.getElementById("skinBonusText");

  // leaderboard ui
  const lbBody = document.getElementById("lbBody");
  const btnClearLB = document.getElementById("btnClearLB");

  // Audio
  const AudioFx = (() => {
    let ac = null;
    const ensure = () => (ac ||= new (window.AudioContext || window.webkitAudioContext)());
    const beep = (f=440, d=0.07, type="sine", v=0.08) => {
      const c = ensure();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = f;
      g.gain.value = v;
      o.connect(g); g.connect(c.destination);
      o.start();
      o.stop(c.currentTime + d);
    };
    return {
      open:   () => beep(320, 0.06, "sine", 0.07),
      hit:    () => beep(180, 0.06, "square", 0.06),
      kill:   () => beep(520, 0.07, "triangle", 0.08),
    };
  })();

  // Utils
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const dist2 = (ax,ay,bx,by)=>{ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; };

  // ===== Images =====
  const PATH_SKIN = "./assets/skins/";
  const PATH_ENEMY = "./assets/enemies/";

  const SKINS = [
    { id:"default",   name:"Default (Cannon)", price:0,   src:PATH_SKIN+"default.png",
      bonus:{}, bonusText:"No bonus." },
    { id:"beam_hat",  name:"Laser Hat",        price:600, src:PATH_SKIN+"beam_hat.png",
      bonus:{ moveSpeed:+30 }, bonusText:"+Move Speed" },
    { id:"missile",   name:"Rocket",           price:800, src:PATH_SKIN+"missile.png",
      bonus:{ balls:+1 }, bonusText:"+1 Fireball" },
    { id:"king",      name:"King Cape",        price:900, src:PATH_SKIN+"king.png",
      bonus:{ hpMax:+1 }, bonusText:"+1 Max HP" },
    { id:"beam_glow", name:"Laser Eyes",       price:700, src:PATH_SKIN+"beam_glow.png",
      bonus:{ orbitSpeed:+0.35 }, bonusText:"+Orbit Speed" },
    { id:"fire",      name:"Fire Breath",      price:650, src:PATH_SKIN+"fire.png",
      bonus:{ ballSize:+0.25 }, bonusText:"+Fireball Size" },
  ];

  const skinImages = new Map();
  for (const s of SKINS) {
    const im = new Image();
    im.src = s.src;
    skinImages.set(s.id, im);
  }

  // Enemy sprites (optional)
  const ENEMY_SPRITES = ["e1.png","e2.png","e3.png","e4.png"].map(n => PATH_ENEMY + n);
  const enemyImages = ENEMY_SPRITES.map(src => {
    const im = new Image();
    im.src = src;
    return im;
  });

  // ===== Input =====
  const keys = new Set();
  document.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
    keys.add(k);

    if (k === "b" && !state.ended) toggleShop();
    if (k === "escape" && state.shopOpen) closeShop();
    if (k === "r") restart();
  }, {passive:false});
  document.addEventListener("keyup", (e)=> keys.delete(e.key.toLowerCase()));

  // ===== Leaderboard =====
  const LB_KEY = "dino_lb_v2";
  const loadLB = () => { try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); } catch { return []; } };
  const saveLB = (rows) => { try { localStorage.setItem(LB_KEY, JSON.stringify(rows)); } catch {} };
  const renderLB = () => {
    const rows = loadLB();
    lbBody.innerHTML = "";
    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">No records yet.</td>`;
      lbBody.appendChild(tr);
      return;
    }
    rows.slice(0,10).forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${r.score}</td><td>${r.kills}</td><td>${r.stage}</td>`;
      lbBody.appendChild(tr);
    });
  };
  btnClearLB.onclick = () => { saveLB([]); renderLB(); setShopStatus("Leaderboard cleared.", false); };

  // ===== State =====
  let state;
  const OWN_KEY = "dino_owned_skins_v2";

  function resetGame() {
    state = {
      // base stats
      base: {
        moveSpeed: 260,
        orbitSpeed: 2.05,
        orbitGap: 44,
        orbitBaseR: 8,
        hpMax: 3,
        balls: 1,
      },

      // runtime derived stats (after skin bonus + shop upgrades)
      player: {
        x: W/2, y: H/2,
        r: 18,
        hp: 3,
        spriteId: "default",
      },

      revive: 1,
      invuln: 0,

      gold: 0,
      kills: 0,
      score: 0,

      // shop upgrades
      up: {
        ballsPlus: 0,     // + fireballs
        rangePlus: 0,     // + orbit gap
      },

      // stage/waves
      stage: 1,
      stageTime: 120,       // ✅ 2 minutes
      stageLeft: 120,
      wavesPerStage: 7,     // ✅ at least 7
      waveIndex: 0,
      waveInterval: 120/7,
      waveTimer: 0,

      enemies: [],
      enemyBullets: [],
      shopOpen: false,
      ended: false,

      ownedSkins: { default: true },
    };

    // load owned skins
    try {
      const saved = JSON.parse(localStorage.getItem(OWN_KEY) || "{}");
      state.ownedSkins = { ...state.ownedSkins, ...saved };
    } catch {}

    applyDerivedStats(true);
    buildSkinShop();
    renderLB();
    // spawn first wave immediately
    state.enemies.length = 0;
    state.waveIndex = 0;
    state.waveTimer = 0;
    spawnWave();
    updateHUD();
  }

  function persistOwned() {
    try { localStorage.setItem(OWN_KEY, JSON.stringify(state.ownedSkins)); } catch {}
  }

  // ===== Skin bonuses => derived stats =====
  function getSkinBonus(id) {
    const s = SKINS.find(x=>x.id===id) || SKINS[0];
    return s.bonus || {};
  }
  function getSkinBonusText(id) {
    const s = SKINS.find(x=>x.id===id) || SKINS[0];
    return `${s.name}: ${s.bonusText || "—"}`;
  }

  function applyDerivedStats(keepHP=false) {
    const bonus = getSkinBonus(state.player.spriteId);

    // derived
    const moveSpeed = state.base.moveSpeed + (bonus.moveSpeed || 0);
    const orbitSpeed = state.base.orbitSpeed + (bonus.orbitSpeed || 0);
    const orbitGap = state.base.orbitGap + state.up.rangePlus + (bonus.orbitGap || 0);
    const orbitBaseR = state.base.orbitBaseR * (1 + (bonus.ballSize || 0));
    const hpMax = state.base.hpMax + (bonus.hpMax || 0);
    const balls = state.base.balls + state.up.ballsPlus + (bonus.balls || 0);

    state.derived = { moveSpeed, orbitSpeed, orbitGap, orbitBaseR, hpMax, balls };

    if (!keepHP) state.player.hp = hpMax;
    else state.player.hp = Math.min(state.player.hp, hpMax);

    skinBonusText.textContent = getSkinBonusText(state.player.spriteId);
  }

  // ===== Enemy scaling =====
  function enemyStats(stage) {
    const hp = 1 + Math.floor(stage/4);
    const speed = 92 + stage*7.5;
    const rangedChance = clamp((stage - 4)*0.09, 0, 0.70);
    const bulletSpeed = 240 + stage*12;
    const fireRate = clamp(1.05 - stage*0.03, 0.40, 1.05);
    return { hp, speed, rangedChance, bulletSpeed, fireRate };
  }

  function spawnWave() {
    // ✅ each wave about 15, later can +1 +2
    const base = 15;
    const extraStage = Math.floor(state.stage * 0.6);  // grows slowly
    const extraRand = Math.floor(rand(0, 3));          // +0~2
    const n = base + extraStage + extraRand;

    const s = enemyStats(state.stage);

    for (let i=0;i<n;i++){
      const side = Math.floor(rand(0,4));
      let x,y;
      if (side===0){ x = rand(-180,-60); y = rand(-120, H+120); }
      if (side===1){ x = rand(W+60, W+180); y = rand(-120, H+120); }
      if (side===2){ x = rand(-120, W+120); y = rand(-180,-60); }
      if (side===3){ x = rand(-120, W+120); y = rand(H+60, H+180); }

      const ranged = Math.random() < s.rangedChance;

      state.enemies.push({
        x,y,
        r: ranged ? 16 : 13,
        hp: s.hp + (ranged ? 1 : 0),
        speed: s.speed * (ranged ? 0.96 : 1.06),
        ranged,
        cd: rand(0.2, 1.2),
        fireRate: s.fireRate,
        bulletSpeed: s.bulletSpeed,
        imgIndex: Math.floor(Math.random() * enemyImages.length),
        alive: true,
      });
    }
  }

  function enemyShoot(e) {
    const p = state.player;
    const dx = p.x - e.x, dy = p.y - e.y;
    const d = Math.hypot(dx,dy) || 1;
    const ux = dx/d, uy = dy/d;
    state.enemyBullets.push({ x:e.x, y:e.y, vx:ux*e.bulletSpeed, vy:uy*e.bulletSpeed, r:6, alive:true });
  }

  // ===== Orbit fireballs =====
  function orbitBalls() {
    const p = state.player;
    const count = Math.max(1, state.derived.balls);
    const gap = state.derived.orbitGap;
    const br = state.derived.orbitBaseR;
    const a0 = state.orbitAngle;

    const arr = [];
    for (let i=0;i<count;i++){
      const a = a0 + (Math.PI*2)*(i/count);
      arr.push({ x: p.x + Math.cos(a)*gap, y: p.y + Math.sin(a)*gap, r: br });
    }
    return arr;
  }

  // ===== Shop =====
  btnCloseShop.onclick = ()=> closeShop();

  function setShopStatus(msg, warn=false){
    shopStatus.textContent = msg;
    shopStatus.className = warn ? "muted warn" : "muted ok";
    setTimeout(()=>{ shopStatus.textContent="—"; shopStatus.className="muted"; }, 1200);
  }

  function openShop(){
    state.shopOpen = true;
    shopOverlay.style.display = "flex";
    AudioFx.open();
    updateShopUI();
    renderLB();
  }
  function closeShop(){
    state.shopOpen = false;
    shopOverlay.style.display = "none";
    focusCanvas();
  }
  function toggleShop(){
    state.shopOpen ? closeShop() : openShop();
  }

  buyMoreBalls.onclick = () => {
    if (state.gold < 30) return setShopStatus("Not enough gold.", true);
    state.gold -= 30;
    state.up.ballsPlus += 1;
    applyDerivedStats(true);
    AudioFx.open();
    setShopStatus("Purchased: +1 Fireball", false);
    updateShopUI();
  };

  buyMoreRange.onclick = () => {
    if (state.gold < 30) return setShopStatus("Not enough gold.", true);
    state.gold -= 30;
    state.up.rangePlus += 10;      // +10 range per purchase
    applyDerivedStats(true);
    AudioFx.open();
    setShopStatus("Purchased: +Orbit Range", false);
    updateShopUI();
  };

  function buySkin(id){
    const s = SKINS.find(x=>x.id===id);
    if (!s) return;
    if (state.ownedSkins[id]) return;
    if (state.gold < s.price) return setShopStatus("Not enough gold.", true);
    state.gold -= s.price;
    state.ownedSkins[id] = true;
    persistOwned();
    AudioFx.open();
    setShopStatus("Purchased: " + s.name, false);
    buildSkinShop();
    updateShopUI();
  }

  function equipSkin(id){
    if (!state.ownedSkins[id]) return setShopStatus("Buy it first.", true);
    state.player.spriteId = id;
    applyDerivedStats(true);
    AudioFx.open();
    setShopStatus("Equipped: " + (SKINS.find(s=>s.id===id)?.name || id), false);
    buildSkinShop();
    updateShopUI();
  }

  function buildSkinShop(){
    skinGrid.innerHTML = "";
    for (const s of SKINS){
      const owned = !!state.ownedSkins[s.id];
      const equipped = state.player.spriteId === s.id;

      const card = document.createElement("div");
      card.className = "card";

      const row = document.createElement("div");
      row.className = "row";

      const left = document.createElement("div");
      left.className = "skinPreview";

      const img = document.createElement("img");
      img.src = s.src;
      img.onerror = () => { img.style.opacity = "0.35"; img.title = "Image not found. Check assets/skins/ filenames."; };
      left.appendChild(img);

      const info = document.createElement("div");
      info.innerHTML = `<div><b>${s.name}</b></div><div class="muted">${s.price===0?"Free":(s.price+" Gold")} · <span class="k">${s.bonusText}</span></div>`;
      left.appendChild(info);

      const btnWrap = document.createElement("div");
      btnWrap.style.display="flex";
      btnWrap.style.gap="8px";

      const btnBuy = document.createElement("button");
      btnBuy.className = "btn primary";
      btnBuy.textContent = owned ? "Owned" : "Buy";
      btnBuy.disabled = owned || s.price===0;
      btnBuy.onclick = ()=> buySkin(s.id);

      const btnEquip = document.createElement("button");
      btnEquip.className = "btn";
      btnEquip.textContent = equipped ? "Equipped" : "Equip";
      btnEquip.disabled = equipped;
      btnEquip.onclick = ()=> equipSkin(s.id);

      btnWrap.appendChild(btnBuy);
      btnWrap.appendChild(btnEquip);

      row.appendChild(left);
      row.appendChild(btnWrap);

      card.appendChild(row);
      skinGrid.appendChild(card);
    }
  }

  function updateShopUI(){
    shopGold.textContent = String(state.gold);
    buyMoreBallsState.textContent = `Current fireballs: ${state.derived.balls}`;
    buyMoreRangeState.textContent = `Current orbit range: ${state.derived.orbitGap}`;
    skinBonusText.textContent = getSkinBonusText(state.player.spriteId);
  }

  // ===== HUD =====
  function updateHUD(){
    hudStage.textContent = `Stage ${state.stage}`;
    hudTime.textContent  = `Time: ${Math.max(0, Math.ceil(state.stageLeft))}`;
    hudWave.textContent  = `Wave: ${Math.max(1, state.waveIndex)}/${state.wavesPerStage}`;
    hudHP.textContent    = `HP: ${"❤".repeat(state.player.hp)}${"·".repeat(Math.max(0, state.derived.hpMax-state.player.hp))}`;
    hudRevive.textContent = `Revive: ${state.revive}`;
    hudGold.textContent  = `Gold: ${state.gold}`;
    hudKills.textContent = `Kills: ${state.kills}`;
    hudScore.textContent = `Score: ${state.score}`;
    hudOrbit.textContent = `Orbit: balls=${state.derived.balls} size=x${(state.derived.orbitBaseR/state.base.orbitBaseR).toFixed(2)} range=${state.derived.orbitGap}`;
  }

  // ===== Damage + revive =====
  function damagePlayer(){
    if (state.invuln > 0) return;
    state.player.hp--;
    state.invuln = 0.55;
    AudioFx.hit();

    if (state.player.hp <= 0){
      if (state.revive > 0){
        state.revive--;
        state.player.hp = state.derived.hpMax;
        state.invuln = 1.2;
        AudioFx.open();
      } else {
        endGame();
      }
    }
  }

  // ===== Game over -> leaderboard =====
  function endGame(){
    if (state.ended) return;
    state.ended = true;

    const rows = loadLB();
    rows.push({ score: state.score, kills: state.kills, stage: state.stage });
    rows.sort((a,b)=> b.score - a.score);
    saveLB(rows.slice(0,10));
    renderLB();
  }

  // ===== Main update =====
  function step(dt){
    if (state.shopOpen || state.ended) return;

    state.invuln = Math.max(0, state.invuln - dt);

    // stage & waves
    state.stageLeft -= dt;
    state.waveTimer += dt;

    // spawn waves over time (>=7 waves)
    while (state.waveIndex < state.wavesPerStage && state.waveTimer >= state.waveInterval) {
      state.waveTimer -= state.waveInterval;
      state.waveIndex++;
      spawnWave();
    }

    // stage ends -> next stage
    if (state.stageLeft <= 0) {
      state.stage++;
      state.stageLeft = state.stageTime;

      state.waveIndex = 0;
      state.waveTimer = 0;
      // optional: slightly faster later
      state.waveInterval = Math.max(10, state.stageTime / state.wavesPerStage - Math.min(7, state.stage * 0.25));

      // spawn first wave immediately to avoid empty screen
      spawnWave();
    }

    // movement
    let mx=0,my=0;
    if (keys.has("w") || keys.has("arrowup")) my -= 1;
    if (keys.has("s") || keys.has("arrowdown")) my += 1;
    if (keys.has("a") || keys.has("arrowleft")) mx -= 1;
    if (keys.has("d") || keys.has("arrowright")) mx += 1;

    const l = Math.hypot(mx,my);
    if (l > 0){ mx/=l; my/=l; }

    const p = state.player;
    p.x = clamp(p.x + mx*state.derived.moveSpeed*dt, p.r, W-p.r);
    p.y = clamp(p.y + my*state.derived.moveSpeed*dt, p.r, H-p.r);

    // orbit
    state.orbitAngle += state.derived.orbitSpeed * dt;
    const balls = orbitBalls();

    // enemies update
    for (const e of state.enemies){
      if (!e.alive) continue;

      const dx = p.x - e.x, dy = p.y - e.y;
      const d = Math.hypot(dx,dy) || 1;
      const ux = dx/d, uy = dy/d;

      e.x += ux * e.speed * dt;
      e.y += uy * e.speed * dt;

      // touch player
      if (dist2(e.x,e.y,p.x,p.y) <= (e.r+p.r)**2){
        e.x -= ux*10; e.y -= uy*10;
        damagePlayer();
        if (state.ended) break;
      }

      // ranged
      if (e.ranged){
        e.cd -= dt;
        if (e.cd <= 0){
          enemyShoot(e);
          e.cd = e.fireRate;
        }
      }

      // orbit hits (no tracking)
      for (const b of balls){
        if (dist2(e.x,e.y,b.x,b.y) <= (e.r+b.r)**2){
          e.hp -= 1;
          if (e.hp <= 0){
            e.alive = false;
            state.kills++;
            state.gold++;
            state.score += 10 + Math.floor(state.stage*2);
            AudioFx.kill();
          }
          break;
        }
      }
    }

    // enemy bullets
    for (const bl of state.enemyBullets){
      if (!bl.alive) continue;
      bl.x += bl.vx * dt;
      bl.y += bl.vy * dt;
      if (bl.x < -100 || bl.x > W+100 || bl.y < -100 || bl.y > H+100){ bl.alive=false; continue; }
      if (dist2(bl.x,bl.y,p.x,p.y) <= (bl.r+p.r)**2){
        bl.alive=false;
        damagePlayer();
        if (state.ended) break;
      }
    }

    // cleanup
    state.enemies = state.enemies.filter(e=>e.alive);
    state.enemyBullets = state.enemyBullets.filter(b=>b.alive);

    updateHUD();
  }

  // ===== Draw =====
  function draw(){
    ctx.clearRect(0,0,W,H);

    // star dots
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = "#fff";
    for (let y=18;y<H;y+=36) for (let x=18;x<W;x+=36) ctx.fillRect(x,y,1,1);
    ctx.restore();

    // enemy bullets
    for (const b of state.enemyBullets){
      ctx.save();
      ctx.fillStyle = "rgba(140,208,255,.92)";
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // enemies (with image if loaded)
    for (const e of state.enemies){
      ctx.save();

      const im = enemyImages[e.imgIndex];
      const size = e.r * 2.6;

      if (im && im.complete && im.naturalWidth > 0) {
        ctx.drawImage(im, e.x - size/2, e.y - size/2, size, size);
      } else {
        ctx.fillStyle = e.ranged ? "rgba(138,208,255,.92)" : "rgba(255,122,168,.92)";
        ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = "rgba(0,0,0,.55)";
        ctx.beginPath();
        ctx.arc(e.x - e.r*0.25, e.y - e.r*0.18, Math.max(2, e.r*0.12), 0, Math.PI*2);
        ctx.arc(e.x + e.r*0.25, e.y - e.r*0.18, Math.max(2, e.r*0.12), 0, Math.PI*2);
        ctx.fill();
      }

      ctx.restore();
    }

    // orbit fireballs
    const balls = orbitBalls();
    for (const b of balls){
      ctx.save();
      ctx.fillStyle = "rgba(255,190,110,.95)";
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = "rgba(255,255,255,.75)";
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // player sprite
    const p = state.player;
    const img = skinImages.get(p.spriteId);
    const size = 56;

    ctx.save();
    if (state.invuln > 0) ctx.globalAlpha = 0.65;

    if (img && img.complete && img.naturalWidth > 0){
      ctx.drawImage(img, p.x - size/2, p.y - size/2, size, size);
    } else {
      // fallback
      ctx.fillStyle = "rgba(120,255,160,.9)";
      ctx.beginPath(); ctx.arc(p.x,p.y,24,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // game over overlay
    if (state.ended){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "bold 36px system-ui";
      ctx.fillText("GAME OVER", W/2 - 110, H/2 - 16);
      ctx.font = "16px system-ui";
      ctx.fillText(`Kills: ${state.kills}   Score: ${state.score}   Stage: ${state.stage}`, W/2 - 170, H/2 + 18);
      ctx.fillText("Press R to restart · Press B for shop/leaderboard", W/2 - 190, H/2 + 46);
      ctx.restore();
    }
  }

  // ===== Loop =====
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;
    step(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function restart(){
    closeShop();
    resetGame();
  }

  // init
  resetGame();
  requestAnimationFrame(loop);

  // ===== Shop open/close helpers (need state) =====
  function updateShopUI(){
    shopGold.textContent = String(state.gold);
    buyMoreBallsState.textContent = `Current fireballs: ${state.derived.balls}`;
    buyMoreRangeState.textContent = `Current orbit range: ${state.derived.orbitGap}`;
    skinBonusText.textContent = getSkinBonusText(state.player.spriteId);
  }
  function openShop(){
    state.shopOpen = true;
    shopOverlay.style.display = "flex";
    AudioFx.open();
    updateShopUI();
    renderLB();
  }
  function closeShop(){
    state.shopOpen = false;
    shopOverlay.style.display = "none";
    focusCanvas();
  }
  function toggleShop(){
    state.shopOpen ? closeShop() : openShop();
  }
  function setShopStatus(msg, warn=false){
    shopStatus.textContent = msg;
    shopStatus.className = warn ? "muted warn" : "muted ok";
    setTimeout(()=>{ shopStatus.textContent="—"; shopStatus.className="muted"; }, 1200);
  }
})();
</script>
</body>
</html>
